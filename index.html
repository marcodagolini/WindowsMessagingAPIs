<style>
  
   

  
 
@keyframes fadein {
    from {
        opacity:0;
    }
    to {
        opacity:1;
    }
}
@-moz-keyframes fadein { /* Firefox */
    from {
        opacity:0;
    }
    to {
        opacity:1;
    }
}
@-webkit-keyframes fadein { /* Safari and Chrome */
    from {
        opacity:0;
    }
    to {
        opacity:1;
    }
}
@-o-keyframes fadein { /* Opera */
    from {
        opacity:0;
    }
    to {
        opacity:1;
    }
}
  
  
    
#log {
    position:absolute;
    visibility:visible;
    left: 29px; 
    top: 76px;
    width: 256px;
    height: 420px;
    background-color: #ffffff;
    overflow: auto;
    max-height: 420px;
}

  
.invisibleTTRmsg{
    visibility:hidden;
}
  
.invisibleTTR {
    position:absolute;
    left: 29px; 
    top: 76px; 
    resize: none; 
    width: 256px; 
    font-size: 1em;
    background-color: #ffcc99;
    height: 50px;
    visibility:hidden;
}
   
  
.visibleTTRmsg{
    display:table-cell;
    vertical-align:middle;
    text-align:center;
    visibility:visible;
    font-size: 10pt;
    color: black;
    width: 254px;
    height: 50px;
    animation: fadein 2s;
    -moz-animation: fadein 2s; /* Firefox */
    -webkit-animation: fadein 2s; /* Safari and Chrome */
    -o-animation: fadein 2s; /* Opera */
}
  
.visibleTTR {
    position:absolute;
    visibility:visible;
    left: 29px; 
    top: 76px; 
    resize: none; 
    width: 256px; 
    font-size: 1em;
    background-color: #ffcc99;
    height: 50px;
    animation: fadein 2s;
    -moz-animation: fadein 2s; /* Firefox */
    -webkit-animation: fadein 2s; /* Safari and Chrome */
    -o-animation: fadein 2s; /* Opera */
}
  
  
.fullCSAT1 {
    position:absolute;
    visibility:visible;
    left: 0px; 
    top: 100px;
    width: 50px;
    height: 50px;
    background-image: url('https://i.imgur.com/181H3rn.png');
    animation: fadein 2s;
    -moz-animation: fadein 2s; /* Firefox */
    -webkit-animation: fadein 2s; /* Safari and Chrome */
    -o-animation: fadein 2s; /* Opera */
}
  
.fullCSAT2 {
    position:absolute;
    visibility:visible;
    left: 50px; 
    top: 100px;
    width: 50px;
    height: 50px;
    background-image: url('https://i.imgur.com/181H3rn.png');
    animation: fadein 2s;
    -moz-animation: fadein 2s; /* Firefox */
    -webkit-animation: fadein 2s; /* Safari and Chrome */
    -o-animation: fadein 2s; /* Opera */
}
  
.fullCSAT3 {
    position:absolute;
    visibility:visible;
    left: 100px; 
    top: 100px;
    width: 50px;
    height: 50px;
    background-image: url('https://i.imgur.com/181H3rn.png');
    animation: fadein 2s;
    -moz-animation: fadein 2s; /* Firefox */
    -webkit-animation: fadein 2s; /* Safari and Chrome */
    -o-animation: fadein 2s; /* Opera */
}
  
.fullCSAT4 {
    position:absolute;
    visibility:visible;
    left: 150px; 
    top: 100px;
    width: 50px;
    height: 50px;
    background-image: url('https://i.imgur.com/181H3rn.png');
    animation: fadein 2s;
    -moz-animation: fadein 2s; /* Firefox */
    -webkit-animation: fadein 2s; /* Safari and Chrome */
    -o-animation: fadein 2s; /* Opera */
}
  
.fullCSAT5 {
    position:absolute;
    visibility:visible;
    left: 200px; 
    top: 100px;
    width: 50px;
    height: 50px;
    background-image: url('https://i.imgur.com/181H3rn.png');
    animation: fadein 2s;
    -moz-animation: fadein 2s; /* Firefox */
    -webkit-animation: fadein 2s; /* Safari and Chrome */
    -o-animation: fadein 2s; /* Opera */
}
  
  
.invisibleCSAT1 {
    visibility:hidden;
}
  
.invisibleCSAT2 {
    visibility:hidden;
}
  
.invisibleCSAT3 {
    visibility:hidden;
}
  
.invisibleCSAT4 {
    visibility:hidden;
}
  
.invisibleCSAT5 {
    visibility:hidden;
}
  

.emptyCSAT1 {
    position:absolute;
    visibility:visible;
    left: 0px; 
    top: 100px;
    width: 50px;
    height: 50px;
    background-image: url('https://i.imgur.com/kXKlCNo.png');
}
  
.emptyCSAT2 {
    position:absolute;
    visibility:visible;
    left: 50px; 
    top: 100px;
    width: 50px;
    height: 50px;
    background-image: url('https://i.imgur.com/kXKlCNo.png');
}
  
.emptyCSAT3 {
    position:absolute;
    visibility:visible;
    left: 100px; 
    top: 100px;
    width: 50px;
    height: 50px;
    background-image: url('https://i.imgur.com/kXKlCNo.png');
}
  
.emptyCSAT4 {
    position:absolute;
    visibility:visible;
    left: 150px; 
    top: 100px;
    width: 50px;
    height: 50px;
    background-image: url('https://i.imgur.com/kXKlCNo.png');
}
  
.emptyCSAT5 {
    position:absolute;
    visibility:visible;
    left: 200px; 
    top: 100px;
    width: 50px;
    height: 50px;
    background-image: url('https://i.imgur.com/kXKlCNo.png');
}
  
.CSATmsg{
    display:table-cell;
    vertical-align:middle;
    text-align:center;
    visibility:visible;
    font-size: 16pt;
    color: black;
    width: 254px;
    height: 150px;
}
  
.NPSmsg{
    position:absolute;
    display:table-cell;
    vertical-align:middle;
    text-align:center;
    visibility:visible;
    font-size: 16pt;
    color: black;
    width: 254px;
    height: 100px;
    left: -1px; 
    top: 200px; 
}
  
.NPSyes{
    position:absolute;
    display:table-cell;
    vertical-align:middle;
    text-align:center;
    visibility:visible;
    font-size: 16pt;
    color: black;
    width: 20px;
    height: 20px;
    left: 60px; 
    top: 280px; 
}
  
.NPSyesOK{
    position:absolute;
    display:table-cell;
    vertical-align:middle;
    text-align:center;
    visibility:visible;
    font-size: 16pt;
    color: green;
    width: 20px;
    height: 20px;
    left: 60px; 
    top: 280px; 
}
  
.NPSyesFade{
    position:absolute;
    display:table-cell;
    vertical-align:middle;
    text-align:center;
    visibility:visible;
    font-size: 16pt;
    color: black;
    opacity: 0.3;
    width: 20px;
    height: 20px;
    left: 60px; 
    top: 280px; 
}
  
.NPSno{
    position:absolute;
    display:table-cell;
    vertical-align:middle;
    text-align:center;
    visibility:visible;
    font-size: 16pt;
    color: black;
    width: 20px;
    height: 20px;
    left: 160px; 
    top: 280px; 
}
  
.NPSnoOK{
    position:absolute;
    display:table-cell;
    vertical-align:middle;
    text-align:center;
    visibility:visible;
    font-size: 16pt;
    color: red;
    width: 20px;
    height: 20px;
    left: 160px; 
    top: 280px; 
}
  
.NPSnofade{
    position:absolute;
    display:table-cell;
    vertical-align:middle;
    text-align:center;
    visibility:visible;
    font-size: 16pt;
    color: black;
    opacity: 0.3;
    width: 20px;
    height: 20px;
    left: 160px; 
    top: 280px; 
}
  
.csatBG {
    position:absolute;
    visibility:visible;
    left: 0px; 
    top: 0px; 
    background-color: #ffffff;
    width: 256px;
    height: 455px;
}
    
.btn {
    display: inline-block;
    position:absolute;
    visibility:visible;
    left: 238px; 
    top: 504px;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    border-radius: 4px;
}
  
.submitCSAT {
    position:absolute;
    visibility:visible;
    left: 95px; 
    top: 350px;
    padding: 4px 8px;
    font-size: 20px;
    cursor: pointer;
    border-radius: 4px;
}
  
  
    
.form-control { 
    background-color: #bccad6 !important;
    position:absolute;
    visibility:visible;
    left: 31px; 
    top: 504px;
    border: none;
    width: 205px;
    height: 25px;
    font-size: 1em;
}
   
    
.customer {
    margin-left: auto;
    margin-right: 0px;
    text-align: right;
    color: black;
    background-color: #bccad6;
    border-radius: 10px 0px 10px 10px;
    padding: 10px;
    max-width: 70%;
    font-size: 16px;
    word-wrap: break-word;
    display: inline-block;
}
.agent {
    margin-right: auto;
    margin-left: 0px;
    text-align: left;
    color: black;
    background-color: #edf0f2;
    border-radius: 0px 10px 10px 10px;
    padding: 10px;
    max-width: 70%;
    font-size: 16px;
    word-wrap: break-word;
    display: inline-block;
}
  
.cobrowse {
    margin-right: auto;
    margin-left: 0px;
    text-align: left;
    color: black;
    background-color: #ffcc99;
    border-radius: 0px 10px 10px 10px;
    padding: 10px;
    max-width: 70%;
    font-size: 16px;
    word-wrap: break-word;
    display: inline-block;
}
   
    
.intro {
    background-color: #ffffff;  
    text-align: center;
    width: 256px;
    
}
    
    
.spaceagent {
    background-color: #ffffff;  
    text-align: left;
    width: 246px;
    font-size: 8px;
    height: 10px;
    margin-left: 10px;
    
}
    
    
.spacecustomer {
    background-color: #ffffff;  
    text-align: right;
    width: 246px;
    font-size: 8px;
    height: 10px;
    
}
    
    
.space {
    background-color: #ffffff;  
    text-align: right;
    width: 246px;
    font-size: 8px;
    height: 10px;
    
}
    
    
.chiusura {
    background-color: #ffffff;
    text-align: center;
    width: 244px;
}
    
    
    
.hostcustomer {
    background-color: #ffffff;
    text-align: right;
    width: 256px;
}
    
    
.hostagent {
    background-color: #ffffff;
    text-align: left;
    width: 256px;
}
 
 
.image {
    width: 160px;
}
 
.map {
    width: 160px;
}
    
    
    
</style>




<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<!-- BEGIN LivePerson Monitor. -->
<script type="text/javascript">window.lpTag=window.lpTag||{},"undefined"==typeof window.lpTag._tagCount?(window.lpTag={site:'68283988'||"",section:lpTag.section||"",tagletSection:lpTag.tagletSection||null,autoStart:lpTag.autoStart!==!1,ovr:lpTag.ovr||{domain : 'lptag-a.liveperson.net',tagjs : 'tags-a.liveperson.net'},_v:"1.8.0",_tagCount:1,protocol:"https:",events:{bind:function(t,e,i){lpTag.defer(function(){lpTag.events.bind(t,e,i)},0)},trigger:function(t,e,i){lpTag.defer(function(){lpTag.events.trigger(t,e,i)},1)}},defer:function(t,e){0==e?(this._defB=this._defB||[],this._defB.push(t)):1==e?(this._defT=this._defT||[],this._defT.push(t)):(this._defL=this._defL||[],this._defL.push(t))},load:function(t,e,i){var n=this;setTimeout(function(){n._load(t,e,i)},0)},_load:function(t,e,i){var n=t;t||(n=this.protocol+"//"+(this.ovr&&this.ovr.domain?this.ovr.domain:"lptag.liveperson.net")+"/tag/tag.js?site="+this.site);var a=document.createElement("script");a.setAttribute("charset",e?e:"UTF-8"),i&&a.setAttribute("id",i),a.setAttribute("src",n),document.getElementsByTagName("head").item(0).appendChild(a)},init:function(){this._timing=this._timing||{},this._timing.start=(new Date).getTime();var t=this;window.attachEvent?window.attachEvent("onload",function(){t._domReady("domReady")}):(window.addEventListener("DOMContentLoaded",function(){t._domReady("contReady")},!1),window.addEventListener("load",function(){t._domReady("domReady")},!1)),"undefined"==typeof window._lptStop&&this.load()},start:function(){this.autoStart=!0},_domReady:function(t){this.isDom||(this.isDom=!0,this.events.trigger("LPT","DOM_READY",{t:t})),this._timing[t]=(new Date).getTime()},vars:lpTag.vars||[],dbs:lpTag.dbs||[],ctn:lpTag.ctn||[],sdes:lpTag.sdes||[],hooks:lpTag.hooks||[],ev:lpTag.ev||[]},lpTag.init()):window.lpTag._tagCount+=1;</script>
<!-- END LivePerson Monitor. -->


<div style="position:absolute; background-image: url(https://i.imgur.com/b54DM6d.png); height: 607px; width: 312px;">
 
    <div id="log"></div>
    <form class="form-inline" onsubmit="return false">
        <div class="form-group" style="display:inline;">
            <input id="textline" type="text" class="form-control">
        </div>
        <button id="send" class="btn" disabled>invia</button>

        <div class="form-group" style="display:none;">
            <label for="account">Account:</label>
            <input id="account" type="text" class="form-control" value="68283988">
        </div>
   
        <button id="connect" class="btn btn-default" style="display:none;">connect</button>
    </form>

  
    <div id="ttr" class="invisibleTTR">
        <div id="TTRmsg" class="invisibleTTRmsg">Some text</div>
    </div>
  
</div>


<script>
"use strict";
function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }
var LPUtils = function () {
  function LPUtils() {
    _classCallCheck(this, LPUtils);
  }
  LPUtils.getDomain = function getDomain(account, name) {
    var domains = account.startsWith("le") ? "hc1n.dev.lprnd.net" : "adminlogin.liveperson.net";
    return new Promise(function (res, rej) {
      return $.ajax({
        url: "https://" + domains + "/csdr/account/" + account + "/service/" + name + "/baseURI.lpCsds?version=1.0",
        jsonp: "cb",
        jsonpCallback: "domainCallback",
        cache: true,
        dataType: "jsonp",
        success: function success(data) {
          return res(data.ResultSet.lpData[0].lpServer);
        },
        error: function error(e, text) {
          return rej(text);
        }
      });
    });
  };
  LPUtils.agentProfile = function agentProfile(account, agentID) {
    var _this = this;
    return new Promise(function (res, rej) {
      return _this.getDomain(account, "acCdnDomain").then(function (accdnDomain) {
        return $.ajax({
          url: "https://" + accdnDomain + "/api/account/" + account + "/configuration/le-users/users/" + agentID,
          jsonp: "cb",
          jsonpCallback: "apCallback",
          cache: true,
          dataType: "jsonp",
          success: function success(accdnResp) {
            return res(accdnResp);
          }
        });
      });
    });
  };
  LPUtils.signup = function signup(account) {
    var _this2 = this;
    return new Promise(function (res, rej) {
      return _this2.getDomain(account, "idp").then(function (idpDomain) {
          var jwt = "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwczovL3NvbWV0aGluZy5pdCIsInN1YiI6IjY1NzU2NzU5NTYiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJKb2huRG9lIiwicGhvbmVfbnVtYmVyIjoiKzEtMTAtMzQ0LTM3NjUzMzMiLCJnaXZlbl9uYW1lIjoiVGVzdCIsImZhbWlseV9uYW1lIjoiVGVzdDIiLCJlbWFpbCI6ImVtYWlsQGVtYWlsLmNvbSIsImdlbmRlciI6Ik1hbGUiLCJscF9zZGVzIjpbeyJ0eXBlIjoiY3RtcmluZm8iLCJpbmZvIjp7ImNzdGF0dXMiOiJjYW5jZWxsZWQiLCJjdHlwZSI6InZpcCIsImN1c3RvbWVySWQiOiI2NTc1Njc1OTU2IiwiYmFsYW5jZSI6Ii00MDAuOTkiLCJzb2NpYWxJZCI6IjM0NTY3ODc2NTQiLCJpbWVpIjoiOTk5NjYzMjEiLCJ1c2VyTmFtZSI6InVzZXIwMDAiLCJjb21wYW55U2l6ZSI6IjUwMCIsImFjY291bnROYW1lIjoiYmFuayBjb3JwIiwicm9sZSI6ImJyb2tlciIsImxhc3RQYXltZW50RGF0ZSI6eyJkYXkiOiIxNSIsIm1vbnRoIjoiMTAiLCJ5ZWFyIjoiMjAxNCJ9LCJyZWdpc3RyYXRpb25EYXRlIjp7ImRheSI6IjIzIiwibW9udGgiOiI1IiwieWVhciI6IjIwMTMifX19LHsidHlwZSI6InBlcnNvbmFsIiwicGVyc29uYWwiOnsiZmlyc3RuYW1lIjoiSm9obiIsImxhc3RuYW1lIjoiRG9lIiwiYWdlIjp7ImFnZSI6IjM0IiwieWVhciI6IjE5ODAiLCJtb250aCI6IjQiLCJkYXkiOiIxNSJ9LCJjb250YWN0cyI6W3siZW1haWwiOiJteW5hbWVAZXhhbXBsZS5jb20iLCJwaG9uZSI6IjAwMzkgMzQ3IDc1NzY1NzcifV0sImdlbmRlciI6Ik1BTEUiLCJjb21wYW55IjoiTGl2ZVBlcnNvbiJ9fV0sImlhdCI6MTUxMjczNzAyOCwiZXhwIjoyMTEyNzM3MDI4fQ.MKseiL8ZdAslsj2plhRsYt-RgHgFDef2XyF9Rc4fjWIkocDRkURG4O9KRPm70ioQ2hohMKRcxcBLIo9jqUO5gTz1Fb5vEYkTtHIMfH2Hrfi9XjKSVeC2p6Xc7E9Xzqm3GQxBRROrGjCdW1lJqbINsJMmmwrDf8ABMMaXrJnhgPWHHcU-SYkcbGsFSBgLIOmqSdRFegJc2z9REm2_rHO8oE-fPZnckRRNV1hm6Yan8ZDjITNUw6ooucZk-aJyP6MPrbw0_-FL8TSmHmSGDiXFmp1Tde4vUTtRAK7Hkb8Mh6nI0A0CqjDdNtfc1yU0CSGgvJpEPKUQC5-o94YxK0Db2g";
          return $.ajax({
          "url": "https://" + idpDomain + "/api/account/" + account + "/authenticate",
          "async": true,
          "crossDomain": true,
          "method": "POST",
          "headers": {
               "content-type": "application/json"
          },
          "processData": false,
          "data": "{\"authCode\" : \"" + jwt + "\"}",
          success: function success(idpResp) {
            return res(idpResp.jwt);
          }
        });
      });
    });
  };
  // fetch jwt from localstorage or create one
  LPUtils.getJWT = function getJWT(account) {
    var localJWT = localStorage.getItem(account + "-jwt");
    if (localJWT) return Promise.resolve(localJWT);else return this.signup(account).then(function (newJWT) {
      localStorage.setItem(account + "-jwt", newJWT);
      return Promise.resolve(newJWT);
    });
  };
  LPUtils.clearJWT = function clearJWT(account) {
    localStorage.removeItem(account + "-jwt");
  };
  return LPUtils;
}();
// LPUtils.getDomain("qa20971604", "idp").then(r => console.log(r));
// LPUtils.signup("qa20971604").then(r => console.log(r));
var LPWs = function () {
  LPWs.connect = function connect(url) {
    return new LPWs(url)._connect();
  };
  LPWs.connectDebug = function connectDebug(url) {
    return new LPWs(url, true)._connect();
  };
  function LPWs(url, debug) {
    _classCallCheck(this, LPWs);
    this.reqs = {};
    this.subs = [];
    this.url = url;
    this.debug = debug;
  }
  LPWs.prototype._connect = function _connect() {
    var _this3 = this;
    return new Promise(function (resolve, reject) {
      var ws = new WebSocket(_this3.url);
      _this3.ws = ws;
      ws.onopen = function () {
        return resolve(_this3);
      };
      ws.onmessage = function (msg) {
        return _this3.onmessage(msg);
      };
      ws.onclose = function (evt) {
        _this3.ws = null;
        reject(evt);
      };
    });
  };
  LPWs.prototype.request = function request(type, body, headers) {
    var _this4 = this;
    return new Promise(function (resolve, reject) {
      var obj = {
        "kind": "req",
        "type": type,
        "body": body,
        "id": Math.floor(Math.random() * 1e9),
        "headers": headers
      };
      _this4.reqs[obj.id] = function (type, code, body) {
        return resolve({
          type: type,
          code: code,
          body: body
        });
      };
      var str = JSON.stringify(obj);
      if (_this4.debug) console.log("sending: " + str);
      _this4.ws.send(str);
    });
  };
  LPWs.prototype.onNotification = function onNotification(filterFunc, _onNotification) {
    this.subs.push({
      filter: filterFunc,
      cb: _onNotification
    });
  };
  LPWs.prototype.toFuncName = function toFuncName(reqType) {
    var str = reqType.substr(1 + reqType.lastIndexOf('.'));
    return str.charAt(0).toLowerCase() + str.slice(1);
  };
  LPWs.prototype.registerRequests = function registerRequests(arr) {
    var _this5 = this;
    arr.forEach(function (reqType) {
      return _this5[_this5.toFuncName(reqType)] = function (body, headers) {
        return _this5.request(reqType, body, headers);
      };
    });
  };
  LPWs.prototype.onmessage = function onmessage(msg) {
    if (this.debug) console.log("recieved: " + msg.data);
    var obj = JSON.parse(msg.data);
    if (obj.kind == "resp") {
      var id = obj.reqId;
      delete obj.reqId;
      delete obj.kind;
      this.reqs[id].call(this, obj.type, obj.code, obj.body);
      delete this.reqs[id];
    } else if (obj.kind == "notification") {
      this.subs.forEach(function (sub) {
        if (sub.filter.call(this, obj)) {
          sub.cb.call(this, obj.body);
        };
      });
    }
  };
  return LPWs;
}();
// LPWs.connect("wss://echo.websocket.org").then(lpws => console.log(`lpws was opened.`));
</script>













<script>
  
  
  
function notifyMe(text) {

    var notification = new Notification('Nuova notifica', {
      icon: 'https://i.imgur.com/Y5zmGTw.png',
      body: text,
    });

    notification.onclick = function () {
      window.open("https://liveperson.com");      
    };

}
  
  
function AllowNotifications() {
  if (!Notification) {
    return;
  }

  if (Notification.permission !== "granted")
    Notification.requestPermission();

}
  
AllowNotifications();
  
  
var manualETTR = 0;
  
//**** actions
var publishText = '<div onclick="console.log(this.firstChild.title); (document.getElementsByClassName(\'form-control\')[0]).value = this.firstChild.title; return false;" ></div>';
var publishTextData = function publishTextData(message){
  var message2 = message.replace(/'/ig, "\\'");
  return '<div onclick="console.log(\''+ message2 +'\'); (document.getElementsByClassName(\'form-control\')[0]).value = \''+ message2 +'\'; return false;" ></div>';
}
var linkOut = function linkOut(url) {
  return '<a href="' + url + '" target="_blank"></a>';
}
var navigate = function navigate(la, lo) {
  var mapsDomain = 'https://www.google.com/maps/place/\/@' + la + ',' + lo + ',14z/';
  return "<a target='_blank' href=" + mapsDomain + "></a>"
}
//**** *******
$(document).ready(() => { 
  prepareToConnect();
  $('#connect').click();  
});
function prepareToConnect() {
  $('#connect').text('connect').unbind('click').click(() => {
    $('#connect').text('connecting...');
    const account = $('#account').prop('disabled',true).val();
    LPUtils.getJWT(account).then(jwt => {
      LPUtils.getDomain(account, 'asyncMessagingEnt').then(umsDomain => {
        LPWs.connect(`wss://${umsDomain}/ws_api/account/${account}/messaging/consumer?v=3`)
        .then(
          openedSocket => {handleOpenedSocket(openedSocket,jwt);}, 
          errorOpening => {
            $('#log').append(`error opening connection ${errorOpening}\n`);
            prepareToConnect();
          });
      });
    }, errorGettingJwt => {
      $('#connect').text('connect');
      $('#account').prop('disabled',false).val();      
      $('#log').append(`error ${errorGettingJwt} getting jwt for account ${account}\n`);
    });
  });
 
}
function handleOpenedSocket(socket,jwt) {
    
    
  $('.intro').remove();
  $('.agent').remove();
  $('.customer').remove();
  $('.space').remove();
  $('.spaceagent').remove();
  $('.spacecustomer').remove();
  $('.lp-panel').remove();
    
    
  var space = document.createElement('div');
  space.setAttribute("class","space");        
  var maindiv = document.getElementById('log');
  maindiv.appendChild(space);
    
  var newdiv = document.createElement('div');
  newdiv.setAttribute("class","intro");
  newdiv.innerHTML = "Benvenuti nel nuovo servizio di Messaging asincrono!<br><br>I nostri Agenti saranno presto disponibili.<br><br>";
  var mydiv = document.getElementById('log');
  mydiv.appendChild(newdiv);
 
  
    
  socket.registerRequests(apiRequestTypes);
  const me = myId(jwt);
    
  //console.log(jwt);
  
  socket.initConnection({},[{"type":".ams.headers.ClientProperties","deviceFamily":"DESKTOP","os":"WINDOWS","features":["CO_BROWSE"]},{ "type": ".ams.headers.ConsumerAuthentication", "jwt": jwt}]);
    
  socket.onNotification(withType('MessagingEvent'),
    body => body.changes.forEach(change => {
      
      console.log(change);     
      switch (change.event.type) {
              
         case 'RichContentEvent':
              
              if (((new Date().getTime()) - change.serverTimestamp)/1000 < 10)
                  notifyMe("Nuovo contenuto strutturato");
          
              var space = document.createElement('div');
              space.setAttribute("class","spaceagent");
              var options = {'weekday': 'long', 'month': '2-digit', 'day': '2-digit', 'hour': '2-digit', 'minute': '2-digit', 'second': '2-digit'};
              space.innerHTML = new Date(change.serverTimestamp).toLocaleString('it-IT', options);
              var maindiv = document.getElementById('log');
              maindiv.appendChild(space);
                  
              
              
              /********* TODO: structured content rendering ***************/
                  
              var json = change.event.content;
              try {
                 
                var panelgroup = document.createElement("div");
                panelgroup.setAttribute("class","hostagent");
                var maindiv = document.getElementById('log');
                maindiv.appendChild(panelgroup);
               
                  
                var typelist = "verticalhorizontal";
                if ((json.hasOwnProperty("type")) && (json.hasOwnProperty("elements")) && (typelist.indexOf(json.type) > -1)) {
                    function appendHorizontalLayout(jsonElements, macroGroup) {
                        var panelchoice = document.createElement("div");
                        macroGroup.appendChild(panelchoice);
                        panelchoice.style.border = "1px solid #cacaca";
                        panelchoice.style.backgroundColor = "#FAFAFA";
                        panelchoice.style.clear = "both";
                        panelchoice.style.width = "180px";
                        panelchoice.style.textAlign = "center";
                        panelchoice.style.whiteSpace = "nowrap";
                        panelchoice.style.paddingTop = "10px";
                        panelchoice.style.paddingBottom = "10px";
                        var k = -1;
                        jsonElements.forEach(function(element) {
                            k++;
                            if (k == 0) {
                                panelchoice.style.borderTopLeftRadius = "4px";
                                panelchoice.style.borderBottomLeftRadius = "4px";
                               
                            }
                            if (k == jsonElements.length - 1) {
                                panelchoice.style.borderTopRightRadius = "4px";
                                panelchoice.style.borderBottomRightRadius = "4px";
                                
                            }
                            var el_macropanelel_wrapper = document.createElement('div');
                            var el_panelelement = document.createElement("div");
                            var element = jsonElements[k];
                            //**** types
                            if (element.hasOwnProperty("type")) {
                                
                                switch (element.type) {
                                    case "vertical":
                                        appendHorizontalLayout(element.elements, el_macropanelel_wrapper);
                                        break;
                                    case "horizontal":
                                        console.error("le_enh_vis:: Horizontal subgroups not allowed!");
                                        //This should result in an error
                                        break;
                                    case "linkPreview":
                                        //TODO - add in link preview
                                        el_panelelement.innerHTML = "<div><a href='" + element.url + "'>" + element.title + "</a></div>";
                                        el_panelelement = el_panelelement.firstChild;
                                        el_panelelement.style.textAlign = "center";
                                        break;
                                        
                                    case "map":
                                        //var itemDataTruncated = item.data.text.length > 20 ? (item.data.text.substring(0, 20) + "...") : item.data.text;
                                        el_panelelement.innerHTML = "<div><img width=\"160px\" src='https://maps.googleapis.com/maps/api/staticmap?center=" + element.la + "," + element.lo + "&markers=color:blue%7Clabel:A%7C" + element.la + "," + element.lo + "&zoom=14&size=167x111&key=AIzaSyD0FAiv_la9dq8c70_ETYu1i-eoaJktNEo' style='width:auto;height:90%;max-height:111px;'></div>";
                                        el_panelelement = el_panelelement.firstChild;
                                        el_panelelement.style.textAlign = "center";
                                        break;
                                        
                                    case "button":
                                        var itemDataTruncated = element.title ? (element.title.length > 20 ? (element.title.substring(0, 20) + "...") : element.title) : "";
                                        el_panelelement.innerHTML = '<div style="text-align:center;" title="' + element.title + '"  ' +
                                        ' ">' + itemDataTruncated + '</div>';
                                        el_panelelement = el_panelelement.firstChild;
                                        break;
                                        
                                    case "text":
                                        var styleString = 'style =\"';
                                        Object.keys(element.style).forEach(function(prop) {
                                            if (element.style.hasOwnProperty(prop)) {
                                                styleString += prop + ': ' + element.style[prop] + ' !important; ';
                                            }
                                        });
                                        styleString += '\";';
                                        el_panelelement.innerHTML = '<div class="lp-panel-text" ' + styleString + ' title="' + element.text + '">' + element.text + '</div>';
                                        el_panelelement = el_panelelement.firstChild;
                                        break;
                                        
                                    case "image":
                                        el_panelelement.innerHTML = element.url ? "<div><img width=\"160px\" src='" + element.url + "'></div>" : "<img />";
                                        el_panelelement = el_panelelement.firstChild;
                                        el_panelelement.style.textAlign = "center";
                                        break;
                                 }
                            }
                            //**** types
                            //**** Set Action
                            if (element.hasOwnProperty("click") && element.click.hasOwnProperty("actions")) {
                                switch (element.click.actions[0].type) {
                                    case 'link':
                                        el_macropanelel_wrapper.innerHTML = linkOut(element.click.actions[0].uri);
                                        break;
                                    case 'publishText':
                                        el_macropanelel_wrapper.innerHTML = publishTextData(element.click.actions[0].text);
                                        break;
                                    case 'navigate':
                                        el_macropanelel_wrapper.innerHTML = navigate(element.click.actions.la, element.click.actions[0].lo);
                                        break;
                                }
                                el_macropanelel_wrapper.firstChild.appendChild(el_panelelement);
                            } else {
                                el_macropanelel_wrapper.appendChild(el_panelelement);
                            }
                            panelchoice.appendChild(el_macropanelel_wrapper);
                       });
                    }
                var orientation = json.type;
                if (orientation === "horizontal") {
                    panelgroup.style.width = (210 * json.elements.length) + "px";
                    json.elements.forEach(function(el) {
                        appendHorizontalLayout([el], panelgroup);
                    });
                } else {
                    panelgroup.style.width = (180 + "px");
                    appendHorizontalLayout(json.elements, panelgroup);
                }
            }
         } catch (e) {
            console.log(e);
         }
        break;
              
        
        case 'ContentEvent':
              
              
               if(change.originatorId===me){
                   var space = document.createElement('div');
                   space.setAttribute("class","spacecustomer");
                   var options = {'weekday': 'long', 'month': '2-digit', 'day': '2-digit', 'hour': '2-digit', 'minute': '2-digit', 'second': '2-digit'};
                   space.innerHTML = new Date(change.serverTimestamp).toLocaleString('it-IT', options);
                   var maindiv = document.getElementById('log');
                   maindiv.appendChild(space);
                   
                   var hostdiv = document.createElement('div');
                   hostdiv.setAttribute("class","hostcustomer");
                   var newdiv = document.createElement('div');
                   newdiv.setAttribute("class","customer");
                   newdiv.innerHTML = change.event.message;                
                   var maindiv = document.getElementById('log');
                   maindiv.appendChild(hostdiv);
                   hostdiv.appendChild(newdiv);
               }
              
               else{
                 
                   if (((new Date().getTime()) - change.serverTimestamp)/1000 < 10)
                      notifyMe(change.event.message);
                 
                   var space = document.createElement('div');
                   space.setAttribute("class","spaceagent");
                   var options = {'weekday': 'long', 'month': '2-digit', 'day': '2-digit', 'hour': '2-digit', 'minute': '2-digit', 'second': '2-digit'};
                   space.innerHTML = new Date(change.serverTimestamp).toLocaleString('it-IT', options);
                   var maindiv = document.getElementById('log');
                   maindiv.appendChild(space);
                   
                   var hostdiv = document.createElement('div');
                   hostdiv.setAttribute("class","hostagent");
                   var newdiv = document.createElement('div');
                   newdiv.setAttribute("class","agent");
                   newdiv.innerHTML = change.event.message;                
                   var maindiv = document.getElementById('log');
                   maindiv.appendChild(hostdiv);
                   hostdiv.appendChild(newdiv);
                   
                  
               }
              
              break;
              
              
              var textarea = document.getElementById('log');
              textarea.scrollTop = textarea.scrollHeight;
      }
    }));
  // subscribe to open conversations metadata
  socket.subscribeExConversations({
    'convState': ['OPEN']
  }).then(resp => {
    var openConvs = {};
    socket.onNotification(withSubscriptionID(resp.body.subscriptionId),
      (notificationBody) => handleConversationNotification(socket,notificationBody,openConvs));
    $('#send').prop('disabled', false).click(() => {
        
       if($('#textline').val()) {
         if (Object.keys(openConvs)[0]) {
           publishTo(socket,Object.keys(openConvs)[0]);
           testphotosharing(socket,Object.keys(openConvs)[0]);
         } else  {
           socket.consumerRequestConversation()
             .then(resp => {publishTo(socket,resp.body.conversationId); testphotosharing(socket,resp.body.conversationId);});
         }
       }
        
    });
    $('#close').prop('disabled', false).click(() => {
      if (Object.keys(openConvs)[0]) {
        socket.updateConversationField({
            conversationId: Object.keys(openConvs)[0],
            conversationField: [{
                    field: "ConversationStateField",
                    conversationState: "CLOSE"
                }]
        });
      }
    });
  });
  $('#connect').text('disconnect').unbind('click').click(() => socket.ws.close());
  
  window.setInterval(socket.getClock, 30000)
  //socket.getClock();
  socket.ws.onclose = (evt) => onCloseSocket(socket,evt);
}
    
    
    
    
function handleConversationNotification(socket,notificationBody,openConvs) {
  notificationBody.changes.forEach(change => {
    console.log(change);
    if (change.type === 'UPSERT') {
      
      if(change.result.conversationDetails.manualETTR != manualETTR){
         var giorni, ore, minuti;
         var messaggio = "";
         manualETTR = change.result.conversationDetails.manualETTR;
         if (manualETTR){
              var currentDate = new Date().getTime();
              var diff = (manualETTR - currentDate)/1000 + 10;
              if (Math.floor(diff/(60*60*24)) > 0){
                    giorni = Math.floor(diff/(60*60*24));
                    diff = diff - giorni*60*60*24;
                    ore = Math.floor(diff/(60*60));
                    diff = diff - ore*60*60;
                    minuti = Math.floor(diff/60);
                    messaggio = "Un Agente rispondera' entro:</br>" + giorni + " giorni, " + ore + " ore, " + minuti + " minuti.";
              }
              else if (Math.floor(diff/(60*60)) > 0){
                    ore = Math.floor(diff/(60*60));
                    diff = diff - ore*60*60;
                    minuti = Math.floor(diff/60);
                    messaggio = "Un Agente rispondera' entro:</br>" +  ore + " ore, " + minuti + " minuti.";
              }
              else if (Math.floor(diff/(60)) > 0){
                    minuti = Math.floor(diff/60);
                    messaggio = "Un Agente rispondera' entro:</br>" + minuti + " minuti.";
              }
              else {
                    messaggio = "Ci scusiamo per il ritardo.</br>Risponderemo appena possibile!";
              }
         }
         else{
                messaggio = "Un Agente rispondera' appena possibile";
         }
         document.getElementById("TTRmsg").innerHTML = messaggio;
         $("#ttr").removeClass("invisibleTTR");
         $("#ttr").addClass("visibleTTR");
         $("#TTRmsg").removeClass("invisibleTTRmsg");
         $("#TTRmsg").addClass("visibleTTRmsg");
        
         setTimeout(function(){ 
            document.getElementById("TTRmsg").innerHTML = "";
            $("#ttr").removeClass("visibleTTR");
            $("#ttr").addClass("invisibleTTR");
            $("#TTRmsg").removeClass("visibleTTRmsg");
            $("#TTRmsg").addClass("invisibleTTRmsg");
         }, 8000);
      }
      
      if (!openConvs[change.result.convId]) {
        openConvs[change.result.convId] = change.result;
        socket.subscribeMessagingEvents({
          fromSeq: 0,
          dialogId: change.result.convId
        });
      }
        if((change.result.conversationDetails.dialogs.length) > 1){ //*
          
          if(change.result.conversationDetails.dialogs["1"].dialogId==="COAPP"){
        
            if(change.result.conversationDetails.dialogs["1"].metaData.sessionState==="CLOSED"){
                $(".cobrowse").hide();
            }
        
            if(change.result.conversationDetails.dialogs["1"].metaData.sessionState==="INVITED"){
          
              var space = document.createElement('div');
              space.setAttribute("class","spaceagent");
              var options = {'weekday': 'long', 'month': '2-digit', 'day': '2-digit', 'hour': '2-digit', 'minute': '2-digit', 'second': '2-digit'};
              space.innerHTML = new Date(change.result.conversationDetails.metaDataLastUpdateTs).toLocaleString('it-IT', options) + " *** Cobrowse invitation";
              var maindiv = document.getElementById('log');
              maindiv.appendChild(space);
          
              var hostdiv = document.createElement('div');
              hostdiv.setAttribute("class","hostagent");
              var newdiv = document.createElement('div');
              newdiv.setAttribute("class","cobrowse");
              newdiv.innerHTML = "Sei stato invitato ad una sessione di CoBrowse di tipo " + change.result.conversationDetails.dialogs["1"].metaData.mode + "<br />";                
              var newAccept = document.createElement('button');
              newAccept.setAttribute("id","accept");
              newAccept.innerHTML = "Accetta";
              var newDecline = document.createElement('button');
              newDecline.setAttribute("id","decline");
              newDecline.innerHTML = "Declina";
              var maindiv = document.getElementById('log');
              maindiv.appendChild(hostdiv);
              hostdiv.appendChild(newdiv);
              newdiv.appendChild(newAccept);
              newdiv.appendChild(newDecline);
          
              console.log(change.result.conversationDetails.dialogs["1"].metaData.serviceId);
              console.log(change.result.conversationDetails.participants["1"].id);
              console.log(change.result.conversationDetails.participants["0"].id);
          
          
              $(document).on('click', function(evt) {
                  if($(evt.target).is('#accept')) {
                
                      lpTag.events.publish("lpCoBrowse", "cobrowseAccepted", {
 	                        serviceId: change.result.conversationDetails.dialogs["1"].metaData.serviceId,
 	                        agentId: change.result.conversationDetails.participants["1"].id,
 	                        visitorName: change.result.conversationDetails.participants["0"].id,
 	                        //optional parameters:
 	                        ssid: "<Monitoring Session ID>",
 	                        svid: "<Monitoring Visitor ID>",
 	                        scid: "<Monitoring Context ID>",
 	                        cid: "<Context ID>",
 	                        eid: "<Engagement ID>"
                      });
                      $(".cobrowse").hide();
                      var space = document.createElement('div');
                      space.setAttribute("class","spaceagent");
                      var options = {'weekday': 'long', 'month': '2-digit', 'day': '2-digit', 'hour': '2-digit', 'minute': '2-digit', 'second': '2-digit'};
                      space.innerHTML = new Date(change.result.conversationDetails.metaDataLastUpdateTs).toLocaleString('it-IT', options) + " *** Cobrowse accepted";
                      var maindiv = document.getElementById('log');
                      maindiv.appendChild(space);
                
                  }
            
                  else if($(evt.target).is('#decline')) {
                  
                      lpTag.events.publish("lpCoBrowse", "cobrowseDeclined", {
 	                        serviceId: change.result.conversationDetails.dialogs["1"].metaData.serviceId,
 	                        agentId: change.result.conversationDetails.participants["1"].id,
 	                        visitorName: change.result.conversationDetails.participants["0"].id,
 	                        //optional parameters:
 	                        ssid: "<Monitoring Session ID>",
 	                        svid: "<Monitoring Visitor ID>",
 	                        scid: "<Monitoring Context ID>",
 	                        cid: "<Context ID>",
 	                        eid: "<Engagement ID>"
                      });
                      $(".cobrowse").hide();
                      var space = document.createElement('div');
                      space.setAttribute("class","spaceagent");
                      var options = {'weekday': 'long', 'month': '2-digit', 'day': '2-digit', 'hour': '2-digit', 'minute': '2-digit', 'second': '2-digit'};
                      space.innerHTML = new Date(change.result.conversationDetails.metaDataLastUpdateTs).toLocaleString('it-IT', options) + " *** Cobrowse declined";
                      var maindiv = document.getElementById('log');
                      maindiv.appendChild(space);
                
                  }
                  else {
                  
                  }
              });

            }

        }
      
      } //**
    } else if (change.type === 'DELETE') {
      delete openConvs[change.result.convId];
      // $('#log').append(`La conversazione e' stata chiusa.\n`);
      var space = document.createElement('div');
      space.setAttribute("class","space");        
      var maindiv = document.getElementById('log');
      maindiv.appendChild(space);
        
      var newdiv = document.createElement('div');
      newdiv.setAttribute("class","chiusura");
      newdiv.innerHTML = "- La conversazione e' stata chiusa -";
      var mydiv = document.getElementById('log');
      mydiv.appendChild(newdiv);
      
      
      csat(socket, change.result.convId);
      
    }
  });
}
  
function csat(socket, convId){
  
      var CSATresult = null;
      var NPSresult = null;
      var completion;
  
      var bg = document.createElement('div');
      bg.setAttribute("class","csatBG");
      bg.setAttribute("id","csatBG");
      var mydiv = document.getElementById('ttr');
      mydiv.appendChild(bg);
  
  
  
      var CSATmsg = document.createElement('div');
      CSATmsg.setAttribute("class","CSATmsg");
      CSATmsg.setAttribute("id","CSATmsg");
      var mydiv = document.getElementById('csatBG');
      mydiv.appendChild(CSATmsg);
      document.getElementById("CSATmsg").innerHTML = "Dacci un tuo giudizio!";
  

  
      var a = document.createElement('div');
      a.setAttribute("class","emptyCSAT1");
      var mydiv = document.getElementById('csatBG');
      mydiv.appendChild(a);
  
      var b = document.createElement('div');
      b.setAttribute("class","emptyCSAT2");
      var mydiv = document.getElementById('csatBG');
      mydiv.appendChild(b);
  
      var c = document.createElement('div');
      c.setAttribute("class","emptyCSAT3");
      var mydiv = document.getElementById('csatBG');
      mydiv.appendChild(c);
  
      var d = document.createElement('div');
      d.setAttribute("class","emptyCSAT4");
      var mydiv = document.getElementById('csatBG');
      mydiv.appendChild(d);
  
      var e = document.createElement('div');
      e.setAttribute("class","emptyCSAT5");
      var mydiv = document.getElementById('csatBG');
      mydiv.appendChild(e);
  
  
      var csat1 = document.createElement('div');
      csat1.setAttribute("class","invisibleCSAT1");
      csat1.setAttribute("id","csat1");
      var mydiv = document.getElementById('csatBG');
      mydiv.appendChild(csat1);
  
      var csat2 = document.createElement('div');
      csat2.setAttribute("class","invisibleCSAT2");
      csat2.setAttribute("id","csat2");
      var mydiv = document.getElementById('csatBG');
      mydiv.appendChild(csat2);
  
      var csat3 = document.createElement('div');
      csat3.setAttribute("class","invisibleCSAT3");
      csat3.setAttribute("id","csat3");
      var mydiv = document.getElementById('csatBG');
      mydiv.appendChild(csat3);
  
      var csat4 = document.createElement('div');
      csat4.setAttribute("class","invisibleCSAT4");
      csat4.setAttribute("id","csat4");
      var mydiv = document.getElementById('csatBG');
      mydiv.appendChild(csat4);
  
      var csat5 = document.createElement('div');
      csat5.setAttribute("class","invisibleCSAT5");
      csat5.setAttribute("id","csat5");
      var mydiv = document.getElementById('csatBG');
      mydiv.appendChild(csat5);
  
  
      var NPSmsg = document.createElement('div');
      NPSmsg.setAttribute("class","NPSmsg");
      NPSmsg.setAttribute("id","NPSmsg");
      var mydiv = document.getElementById('csatBG');
      mydiv.appendChild(NPSmsg);
      document.getElementById("NPSmsg").innerHTML = "Abbiamo risolto il tuo problema?";
  
      var NPSyes = document.createElement('div');
      NPSyes.setAttribute("class","NPSyes");
      NPSyes.setAttribute("id","NPSyes");
      var mydiv = document.getElementById('csatBG');
      mydiv.appendChild(NPSyes);
      document.getElementById("NPSyes").innerHTML = "Si";
  
      var NPSno = document.createElement('div');
      NPSno.setAttribute("class","NPSno");
      NPSno.setAttribute("id","NPSno");
      var mydiv = document.getElementById('csatBG');
      mydiv.appendChild(NPSno);
      document.getElementById("NPSno").innerHTML = "No";
  
  
      var submitCSAT = document.createElement('button');
      submitCSAT.setAttribute("class","submitCSAT");
      submitCSAT.setAttribute("id","submitCSAT");
      var mydiv = document.getElementById('csatBG');
      mydiv.appendChild(submitCSAT);
      document.getElementById("submitCSAT").innerHTML = "Invia";
  
  
  
  
      
  
      $(document).on('click', function(evt) {
              if($(evt.target).is('.emptyCSAT1')||$(evt.target).is('.fullCSAT1')||$(evt.target).is('.invisibleCSAT1')) {
                  $("#csat1").attr("class","fullCSAT1");
                  $("#csat2").attr("class","invisibleCSAT2");
                  $("#csat3").attr("class","invisibleCSAT3");
                  $("#csat4").attr("class","invisibleCSAT4");
                  $("#csat5").attr("class","invisibleCSAT5");
                  CSATresult = 1;
              }
              if($(evt.target).is('.emptyCSAT2')||$(evt.target).is('.fullCSAT2')||$(evt.target).is('.invisibleCSAT2')) {
                  $("#csat1").attr("class","fullCSAT1");
                  $("#csat2").attr("class","fullCSAT2");
                  $("#csat3").attr("class","invisibleCSAT3");
                  $("#csat4").attr("class","invisibleCSAT4");
                  $("#csat5").attr("class","invisibleCSAT5");
                  CSATresult = 2;
              }
              if($(evt.target).is('.emptyCSAT3')||$(evt.target).is('.fullCSAT3')||$(evt.target).is('.invisibleCSAT3')) {
                  $("#csat1").attr("class","fullCSAT1");
                  $("#csat2").attr("class","fullCSAT2");
                  $("#csat3").attr("class","fullCSAT3");
                  $("#csat4").attr("class","invisibleCSAT4");
                  $("#csat5").attr("class","invisibleCSAT5");
                  CSATresult = 3;
              }
              if($(evt.target).is('.emptyCSAT4')||$(evt.target).is('.fullCSAT4')||$(evt.target).is('.invisibleCSAT4')) {
                  $("#csat1").attr("class","fullCSAT1");
                  $("#csat2").attr("class","fullCSAT2");
                  $("#csat3").attr("class","fullCSAT3");
                  $("#csat4").attr("class","fullCSAT4");
                  $("#csat5").attr("class","invisibleCSAT5");
                  CSATresult = 4;
              }
              if($(evt.target).is('.emptyCSAT5')||$(evt.target).is('.fullCSAT5')||$(evt.target).is('.invisibleCSAT5')) {
                  $("#csat1").attr("class","fullCSAT1");
                  $("#csat2").attr("class","fullCSAT2");
                  $("#csat3").attr("class","fullCSAT3");
                  $("#csat4").attr("class","fullCSAT4");
                  $("#csat5").attr("class","fullCSAT5");
                  CSATresult = 5;
              }
        
              if($(evt.target).is('.NPSyes')||$(evt.target).is('.NPSyesOK')||$(evt.target).is('.NPSyesFade')) {
                  $("#NPSno").attr("class","NPSnoFade");
                  $("#NPSyes").attr("class","NPSyesOK");
                  NPSresult = true;
              }
        
              if($(evt.target).is('.NPSno')||$(evt.target).is('.NPSnoOK')||$(evt.target).is('.NPSnoFade')) {
                  $("#NPSno").attr("class","NPSnoOK");
                  $("#NPSyes").attr("class","NPSyesFade");
                  NPSresult = false;
              }
        
        
              if($(evt.target).is('.submitCSAT')) {
                  if (!(CSATresult == null) && !(NPSresult == null)){
                      completion = "FILLED";  
                  }
                  else if ((CSATresult  == null) && (NPSresult == null)){
                      completion = "SKIPPED";
                  }
                  else {
                      completion = "PARTIALLY_FILLED";
                  }
                
                  
                  socket.updateConversationField({
                          conversationId: convId,
                          conversationField: [{"field":"CSATRate","csatRate":CSATresult,"csatResolutionConfirmation":NPSresult,"status":completion}]
                      });
            
                  $("#csatBG").remove();
                
                
                  
              }
      });
  
      
  
}
  
function onCloseSocket(socket,evt) {
  socket.ws = null;
  // $('#log').append(`connection was closed with code ${evt.code}\n`);
  console.log("closed with code: " + evt.code);
  console.log(evt);
  prepareToConnect();
  $('#send').prop('disabled', true).unbind('click');
  $('#account').prop('disabled',false).val();
  $('#connect').click();        
}
function publishTo(socket,convID) {
  socket.publishEvent({
    dialogId: convID,
    event: {
      type: 'ContentEvent',
      contentType: 'text/plain',
      message: $('#textline').val()
    }
  })
  .then(resp => $('#textline').val(''));
}
  
//*****
  
 function testphotosharing(socket,convID) {
  socket.publishEvent({
    dialogId: convID,
    event: {
      contentType: 'hosted/file',
      eventId: '7C79DFEE-512E-4A39-B2F5-6A45C71260BE',
      message: {
                fileType:'JPG',
                preview:'data:image/jpeg;base64,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'
               }
    }
  });
} 
  
  
//*****
  
function withSubscriptionID(subscriptionID) {
  return notif => notif.body.subscriptionId === subscriptionID;
}
function withType(type) {
  return notif => notif.type.includes(type);
}
function myId(jwt) {
  return JSON.parse(atob(jwt.split('.')[1])).sub;
}
const apiRequestTypes = ['cqm.ExConversationChangeNotification','GetClock','cqm.SubscribeExConversations','ms.PublishEvent','cm.ConsumerRequestConversation','ms.SubscribeMessagingEvents','InitConnection','cm.UpdateConversationField'];
</script>
