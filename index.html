<style>
.LEE_BOARD_ITEM,.lp-panel-body,.lp-panel-heading{cursor:pointer!important;text-align:center!important}.LEE_BOARD_ITEM,.lp-panel-body,.lp-panel-group,.lp-panel-heading{text-align:center!important}.LEE_BOARD_ITEM{border-top:2px #ebf3fb solid!important;padding:4px!important;margin-top:2px!important;vertical-align:middle!important}hr.le-divider{background-color:#bababa!important;height:1px!important;border:1px!important;margin:2px!important}.lp-panel-group{font-family:Verdana,Geneva,sans-serif!important;font-size:13px!important;height:100%!important;white-space:nowrap!important;margin-left:6px!important;margin-right:6px!important;display:-webkit-box!important;width:auto !important;display:-moz-box!important;display:-webkit-flexbox!important;display:-ms-flexbox!important;display:-webkit-flex!important;display:flex!important}.lp-panel-default{border:1px solid #cacaca!important;background-color:#FAFAFA!important;display:inline-block!important}.lp-panel-heading{margin:3px!important;max-height:111px!important}.lp-panel-body{overflow:hidden!important;color:#1178D9!important;padding:.66rem!important;flex:1!important;border-top:1px solid #dadada!important;border-bottom:1px solid #dadada!important}.lp-panel a:hover{background-color:#c1c1c1!important;text-decoration:none!important}.lp-panel-text{text-align:left!important;padding:.25rem!important;word-wrap:break-word!important;white-space:normal!important}.lp-title-text{font-size:15px!important}.lp-type-text{font-size:13px!important;color:#999!important}.lp-bold-text{padding-top:.5rem!important;font-weight:700!important}.lp-panel-heading>img{width:auto!important;max-width:70%!important;height:100%!important;max-height:111px!important}hr{margin:0!important!important}
</style>






<style>
    
    
#log {
    background-color: #ffffff;
    overflow: auto;
    max-height: 420px;
}

   
    
    
.btn {
    display: inline-block;
    padding: 4px 8px;
    font-size: 12px;
    cursor: pointer;
    border-radius: 4px;
}
    

.form-control { 
    background-color: #bccad6 !important;
}

   
    
.customer {
    margin-left: auto;
    margin-right: 0px;
    text-align: right;
    color: black;
    background-color: #bccad6;
    border-radius: 10px 0px 10px 10px;
    padding: 10px;
    max-width: 70%;
    font-size: 16px;
    word-wrap: break-word;
    display: inline-block;
}


.agent {
    margin-right: auto;
    margin-left: 0px;
    text-align: left;
    color: black;
    background-color: #edf0f2;
    border-radius: 0px 10px 10px 10px;
    padding: 10px;
    max-width: 70%;
    font-size: 16px;
    word-wrap: break-word;
    display: inline-block;

}
   
    
.intro {
    background-color: #ffffff;  
    text-align: center;
    width: 256px;
    
}
    
    
.spaceagent {
    background-color: #ffffff;  
    text-align: left;
    width: 246px;
    font-size: 8px;
    height: 10px;
    margin-left: 10px;
    
}
    
    
.spacecustomer {
    background-color: #ffffff;  
    text-align: right;
    width: 246px;
    font-size: 8px;
    height: 10px;
    
}
    
    
.space {
    background-color: #ffffff;  
    text-align: right;
    width: 246px;
    font-size: 8px;
    height: 10px;
    
}
    
    
.chiusura {
    background-color: #ffffff;
    text-align: center;
    width: 244px;
}
    
    
    
.hostcustomer {
    background-color: #ffffff;
    text-align: right;
    width: 256px;
}
    

    
.hostagent {
    background-color: #ffffff;
    text-align: left;
    width: 256px;
}
    
    
    
</style>




<!-- BEGIN LivePerson Monitor. -->
<script type="text/javascript">window.lpTag=window.lpTag||{},"undefined"==typeof window.lpTag._tagCount?(window.lpTag={site:'68283988'||"",section:lpTag.section||"",tagletSection:lpTag.tagletSection||null,autoStart:lpTag.autoStart!==!1,ovr:lpTag.ovr||{domain : 'lptag-a.liveperson.net',tagjs : 'tags-a.liveperson.net'},_v:"1.8.0",_tagCount:1,protocol:"https:",events:{bind:function(t,e,i){lpTag.defer(function(){lpTag.events.bind(t,e,i)},0)},trigger:function(t,e,i){lpTag.defer(function(){lpTag.events.trigger(t,e,i)},1)}},defer:function(t,e){0==e?(this._defB=this._defB||[],this._defB.push(t)):1==e?(this._defT=this._defT||[],this._defT.push(t)):(this._defL=this._defL||[],this._defL.push(t))},load:function(t,e,i){var n=this;setTimeout(function(){n._load(t,e,i)},0)},_load:function(t,e,i){var n=t;t||(n=this.protocol+"//"+(this.ovr&&this.ovr.domain?this.ovr.domain:"lptag.liveperson.net")+"/tag/tag.js?site="+this.site);var a=document.createElement("script");a.setAttribute("charset",e?e:"UTF-8"),i&&a.setAttribute("id",i),a.setAttribute("src",n),document.getElementsByTagName("head").item(0).appendChild(a)},init:function(){this._timing=this._timing||{},this._timing.start=(new Date).getTime();var t=this;window.attachEvent?window.attachEvent("onload",function(){t._domReady("domReady")}):(window.addEventListener("DOMContentLoaded",function(){t._domReady("contReady")},!1),window.addEventListener("load",function(){t._domReady("domReady")},!1)),"undefined"==typeof window._lptStop&&this.load()},start:function(){this.autoStart=!0},_domReady:function(t){this.isDom||(this.isDom=!0,this.events.trigger("LPT","DOM_READY",{t:t})),this._timing[t]=(new Date).getTime()},vars:lpTag.vars||[],dbs:lpTag.dbs||[],ctn:lpTag.ctn||[],sdes:lpTag.sdes||[],hooks:lpTag.hooks||[],ev:lpTag.ev||[]},lpTag.init()):window.lpTag._tagCount+=1;</script>
<!-- END LivePerson Monitor. -->

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>







<div style="position:absolute; background-image: url(https://i.imgur.com/b54DM6d.png); height: 607px; width: 312px;">
<div style="position:relative; left: 30px; top: 75px;">
 <div id="log" style="position:absolute; left: -1px; top: 0px; resize: none; width: 256px; font-size: 1em;">
 </div>
<form class="form-inline" onsubmit="return false" style="position:relative; left: 0px; top: 430px;">
    <div class="form-group" style="display:inline;">
         <label for="textline"></label>
         <input id="textline" type="text" class="form-control" style="border: none; width: 205px;
 height: 25px; font-size: 1em;">
    </div>
    <button id="send" class="btn" disabled>invia</button>

    <div class="form-group" style="display:none;">
        <label for="account">Account:</label>
        <input id="account" type="text" class="form-control" value="68283988">
    </div>
   
    <button id="connect" class="btn btn-default" style="display:none;">connect</button>
 </form>
</div>
</div>


<script>
"use strict";
function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }
var LPUtils = function () {
  function LPUtils() {
    _classCallCheck(this, LPUtils);
  }
  LPUtils.getDomain = function getDomain(account, name) {
    var domains = account.startsWith("le") ? "hc1n.dev.lprnd.net" : "adminlogin.liveperson.net";
    return new Promise(function (res, rej) {
      return $.ajax({
        url: "https://" + domains + "/csdr/account/" + account + "/service/" + name + "/baseURI.lpCsds?version=1.0",
        jsonp: "cb",
        jsonpCallback: "domainCallback",
        cache: true,
        dataType: "jsonp",
        success: function success(data) {
          return res(data.ResultSet.lpData[0].lpServer);
        },
        error: function error(e, text) {
          return rej(text);
        }
      });
    });
  };
  LPUtils.agentProfile = function agentProfile(account, agentID) {
    var _this = this;
    return new Promise(function (res, rej) {
      return _this.getDomain(account, "acCdnDomain").then(function (accdnDomain) {
        return $.ajax({
          url: "https://" + accdnDomain + "/api/account/" + account + "/configuration/le-users/users/" + agentID,
          jsonp: "cb",
          jsonpCallback: "apCallback",
          cache: true,
          dataType: "jsonp",
          success: function success(accdnResp) {
            return res(accdnResp);
          }
        });
      });
    });
  };
  LPUtils.signup = function signup(account) {
    var _this2 = this;
    return new Promise(function (res, rej) {
      return _this2.getDomain(account, "idp").then(function (idpDomain) {
        return $.ajax({
          url: "https://" + idpDomain + "/api/account/" + account + "/signup.jsonp",
          jsonp: "callback",
          dataType: "jsonp",
          success: function success(idpResp) {
            return res(idpResp.jwt);
          }
        });
      });
    });
  };
  // fetch jwt from localstorage or create one
  LPUtils.getJWT = function getJWT(account) {
    var localJWT = localStorage.getItem(account + "-jwt");
    if (localJWT) return Promise.resolve(localJWT);else return this.signup(account).then(function (newJWT) {
      localStorage.setItem(account + "-jwt", newJWT);
      return Promise.resolve(newJWT);
    });
  };
  LPUtils.clearJWT = function clearJWT(account) {
    localStorage.removeItem(account + "-jwt");
  };
  return LPUtils;
}();
// LPUtils.getDomain("qa20971604", "idp").then(r => console.log(r));
// LPUtils.signup("qa20971604").then(r => console.log(r));
var LPWs = function () {
  LPWs.connect = function connect(url) {
    return new LPWs(url)._connect();
  };
  LPWs.connectDebug = function connectDebug(url) {
    return new LPWs(url, true)._connect();
  };
  function LPWs(url, debug) {
    _classCallCheck(this, LPWs);
    this.reqs = {};
    this.subs = [];
    this.url = url;
    this.debug = debug;
  }
  LPWs.prototype._connect = function _connect() {
    var _this3 = this;
    return new Promise(function (resolve, reject) {
      var ws = new WebSocket(_this3.url);
      _this3.ws = ws;
      ws.onopen = function () {
        return resolve(_this3);
      };
      ws.onmessage = function (msg) {
        return _this3.onmessage(msg);
      };
      ws.onclose = function (evt) {
        _this3.ws = null;
        reject(evt);
      };
    });
  };
  LPWs.prototype.request = function request(type, body, headers) {
    var _this4 = this;
    return new Promise(function (resolve, reject) {
      var obj = {
        "kind": "req",
        "type": type,
        "body": body || {},
        "id": Math.floor(Math.random() * 1e9),
        "headers": headers
      };
      _this4.reqs[obj.id] = function (type, code, body) {
        return resolve({
          type: type,
          code: code,
          body: body
        });
      };
      var str = JSON.stringify(obj);
      if (_this4.debug) console.log("sending: " + str);
      _this4.ws.send(str);
    });
  };
  LPWs.prototype.onNotification = function onNotification(filterFunc, _onNotification) {
    this.subs.push({
      filter: filterFunc,
      cb: _onNotification
    });
  };
  LPWs.prototype.toFuncName = function toFuncName(reqType) {
    var str = reqType.substr(1 + reqType.lastIndexOf('.'));
    return str.charAt(0).toLowerCase() + str.slice(1);
  };
  LPWs.prototype.registerRequests = function registerRequests(arr) {
    var _this5 = this;
    arr.forEach(function (reqType) {
      return _this5[_this5.toFuncName(reqType)] = function (body, headers) {
        return _this5.request(reqType, body, headers);
      };
    });
  };
  LPWs.prototype.onmessage = function onmessage(msg) {
    if (this.debug) console.log("recieved: " + msg.data);
    var obj = JSON.parse(msg.data);
    if (obj.kind == "resp") {
      var id = obj.reqId;
      delete obj.reqId;
      delete obj.kind;
      this.reqs[id].call(this, obj.type, obj.code, obj.body);
      delete this.reqs[id];
    } else if (obj.kind == "notification") {
      this.subs.forEach(function (sub) {
        if (sub.filter.call(this, obj)) {
          sub.cb.call(this, obj.body);
        };
      });
    }
  };
  return LPWs;
}();
// LPWs.connect("wss://echo.websocket.org").then(lpws => console.log(`lpws was opened.`));
</script>













<script>
    
    
//**** actions
var publishText = '<div onclick="console.log(this.firstChild.title); (document.getElementsByClassName(\'form-control\')[0]).value = this.firstChild.title; return false;" ></div>';
var publishTextData = function publishTextData(message){
  var message2 = message.replace(/'/ig, "\\'");
  return '<div onclick="console.log(\''+ message2 +'\'); (document.getElementsByClassName(\'form-control\')[0]).value = \''+ message2 +'\'; return false;" ></div>';
}

var linkOut = function linkOut(url) {
  return '<a href="' + url + '" target="_blank"></a>';
}
var navigate = function navigate(la, lo) {
  var mapsDomain = 'https://www.google.com/maps/place/\/@' + la + ',' + lo + ',14z/';
  return "<a target='_blank' href=" + mapsDomain + "></a>"
}
//**** *******



$(document).ready(() => { 
  prepareToConnect();
  $('#connect').click();  
});
function prepareToConnect() {
  $('#connect').text('connect').unbind('click').click(() => {
    $('#connect').text('connecting...');
    const account = $('#account').prop('disabled',true).val();
    LPUtils.getJWT(account).then(jwt => {
      LPUtils.getDomain(account, 'asyncMessagingEnt').then(umsDomain => {
        LPWs.connect(`wss://${umsDomain}/ws_api/account/${account}/messaging/consumer?v=3`)
        .then(
          openedSocket => handleOpenedSocket(openedSocket,jwt), 
          errorOpening => {
            $('#log').append(`error opening connection ${errorOpening}\n`);
            prepareToConnect();
          });
      });
    }, errorGettingJwt => {
      $('#connect').text('connect');
      $('#account').prop('disabled',false).val();      
      $('#log').append(`error ${errorGettingJwt} getting jwt for account ${account}\n`);
    });
  });
 
}
function handleOpenedSocket(socket,jwt) {
    
  $('.intro').remove();
  $('.agent').remove();
  $('.customer').remove();
  $('.space').remove();
  $('.spaceagent').remove();
  $('.spacecustomer').remove();

    
  var space = document.createElement('div');
  space.setAttribute("class","space");        
  var maindiv = document.getElementById('log');
  maindiv.appendChild(space);
    
  var newdiv = document.createElement('div');
  newdiv.setAttribute("class","intro");
  newdiv.innerHTML = "Benvenuti nel nuovo servizio di Messaging asincrono!<br><br>I nostri Agenti saranno presto disponibili.<br><br>";
  var mydiv = document.getElementById('log');
  mydiv.appendChild(newdiv);
 
  
    
  // $('#log').append($("<div class='intro'></div>"));
  // $('.intro').html("Benvenuti nel nuovo servizio di Messaging asincrono di Vodafone.<br><br>I nostri Agenti saranno presto disponibili.<br><br>");
  // $('#log').html(`\nBenvenuti nel nuovo servizio di Messaging asincrono di Vodafone.<br><br>I nostri Agenti saranno presto disponibili.<br><br>`);
  socket.registerRequests(apiRequestTypes);
  const me = myId(jwt);
  
  socket.initConnection({},[{"type":".ams.headers.ClientProperties","deviceFamily":"DESKTOP","os":"WINDOWS","features":["CO_BROWSE"]},{ "type": ".ams.headers.ConsumerAuthentication", "jwt": jwt}]);
  socket.onNotification(withType('MessagingEvent'),
    body => body.changes.forEach(change => {
      
      
      switch (change.event.type) {
              
         case 'RichContentEvent':
              
              var space = document.createElement('div');
              space.setAttribute("class","spaceagent");
              var options = {'weekday': 'long', 'month': '2-digit', 'day': '2-digit', 'hour': '2-digit', 'minute': '2-digit', 'second': '2-digit'};
              space.innerHTML = new Date(change.serverTimestamp).toLocaleString('it-IT', options);
              var maindiv = document.getElementById('log');
              maindiv.appendChild(space);
                  
              
              
              /********* TODO: structured content rendering ***************/
                  
              var json = change.event.content;
              try {
                  
                //console.log(json);
                var panelgroup = document.createElement("div");
                panelgroup.classList.add("lp-panel-group");
                var typelist = "verticalhorizontal";
                if ((json.hasOwnProperty("type")) && (json.hasOwnProperty("elements")) && (typelist.indexOf(json.type) > -1)) {
                    function appendHorizontalLayout(jsonElements, macroGroup) {

                        var panelchoice = document.createElement("div");
                        panelchoice.classList.add("lp-panel");
                        panelchoice.classList.add("lp-panel-default");
                        macroGroup.appendChild(panelchoice);
                        panelchoice.style.border = "1px solid #cacaca";
                        panelchoice.style.backgroundColor = "#FAFAFA";
                        panelchoice.style.clear = "both";
                        panelchoice.style.width = "220px";
                        panelchoice.style.textAlign = "center";
                        panelchoice.style.whiteSpace = "nowrap";
                        var k = -1;
                        jsonElements.forEach(function(element) {
                            k++;
                            if (k == 0) {
                                panelchoice.style.borderTopLeftRadius = "4px";
                                panelchoice.style.borderBottomLeftRadius = "4px";
                                //panelchoice.style.borderRadius = "4px 0px 0px 4px";
                            }
                            if (k == jsonElements.length - 1) {
                                panelchoice.style.borderTopRightRadius = "4px";
                                panelchoice.style.borderBottomRightRadius = "4px";
                                //panelchoice.style.borderRadius = "0px 4px 4px 0px";
                            }

                            var el_macropanelel_wrapper = document.createElement('div');
                            var el_panelelement = document.createElement("div");



                            //**** types
                            if (element.hasOwnProperty("type")) {
                                
                                switch (element.type) {
                                    case "vertical":
                                        appendHorizontalLayout(element.elements, el_macropanelel_wrapper);
                                        break;
                                    case "horizontal":
                                        console.error("le_enh_vis:: Horizontal subgroups not allowed!");
                                        //This should result in an error
                                        break;
                                    case "linkPreview":
                                        //TODO - add in link preview

                                        el_panelelement.innerHTML = "<div><a href='" + element.url + "'>" + element.title + "</a></div>";
                                        el_panelelement = el_panelelement.firstChild;
                                        el_panelelement.style.textAlign = "center";
                                        break;
                                        
                                    case "map":
                                        //var itemDataTruncated = item.data.text.length > 20 ? (item.data.text.substring(0, 20) + "...") : item.data.text;
                                        el_panelelement.innerHTML = "<div><img src='https://maps.googleapis.com/maps/api/staticmap?center=" + element.la + "," + element.lo + "&markers=color:blue%7Clabel:A%7C" + element.la + "," + element.lo + "&zoom=14&size=167x111&key=AIzaSyD0FAiv_la9dq8c70_ETYu1i-eoaJktNEo' style='width:auto;height:90%;max-height:111px;'></div>";
                                        el_panelelement = el_panelelement.firstChild;
                                        el_panelelement.classList.add("lp-panel-heading");
                                        el_panelelement.style.textAlign = "center";
                                        //panelchoice.innerHTML = panelchoice.innerHTML + '<div class="lp-panel-body" title="' + item.data.text + '" '+
                                        //' onclick="console.log(this.title);  (document.getElementsByClassName(\'lp-message-input\')[0]).value = this.title; return false;">'+itemDataTruncated+'</div>';
                                        break;
                                        
                                    case "button":
                                        var itemDataTruncated = element.title ? (element.title.length > 20 ? (element.title.substring(0, 20) + "...") : element.title) : "";
                                        el_panelelement.innerHTML = '<div style="text-align:center;" title="' + element.title + '"  ' +
                                        ' ">' + itemDataTruncated + '</div>';
                                        el_panelelement = el_panelelement.firstChild;
                                        el_macropanelel_wrapper.classList.add("lp-panel-body");
                                        break;
                                        
                                    case "text":
                                        //var itemDataTruncated = element.text ? (element.text.length > 20 ? (element.text.substring(0, 20) + "...") : element.text) : "";
                                        var styleString = 'style =\"';
                                        Object.keys(element.style).forEach(function(prop) {
                                            if (element.style.hasOwnProperty(prop)) {
                                                styleString += prop + ': ' + element.style[prop] + ' !important; ';
                                            }
                                        });
                                        styleString += '\";';
                                        el_panelelement.innerHTML = '<div class="lp-panel-text" ' + styleString + ' title="' + element.text + '">' + element.text + '</div>';
                                        el_panelelement = el_panelelement.firstChild;
                                        break;
                                        
                                    case "image":
                                        el_panelelement.innerHTML = element.url ? "<div><img src='" + element.url + "'></div>" : "<img />";
                                        el_panelelement = el_panelelement.firstChild;
                                        el_panelelement.classList.add("lp-panel-heading");
                                        el_panelelement.style.textAlign = "center";
                                        break;
                                 }
                            }
                            //**** types


                            //**** Set Action
                            if (element.hasOwnProperty("action") && element.action.hasOwnProperty("type")) {
                                switch (element.action.type) {
                                    case 'link':
                                        el_macropanelel_wrapper.innerHTML = linkOut(element.action.uri);
                                        break;
                                    case 'publishText':
                                        el_macropanelel_wrapper.innerHTML = publishTextData(element.action.text);
                                        break;
                                    case 'navigate':
                                        el_macropanelel_wrapper.innerHTML = navigate(element.action.la, element.action.lo);
                                        break;
                                }
                                el_macropanelel_wrapper.firstChild.appendChild(el_panelelement);
                            } else {
                                el_macropanelel_wrapper.appendChild(el_panelelement);
                            }
                            panelchoice.appendChild(el_macropanelel_wrapper);
                       });
                    }
                var orientation = json.type;
                if (orientation === "horizontal") {
                    panelgroup.style.width = (210 * json.elements.length) + "px";
                    json.elements.forEach(function(el) {
                        appendHorizontalLayout([el], panelgroup);
                    });
                } else {
                    panelgroup.style.width = (210 + "px");
                    appendHorizontalLayout(json.elements, panelgroup);
                }
            }
            var outerScroll = document.createElement('div');
            outerScroll.appendChild(panelgroup);
            outerScroll.style.maxWidth = "260px";
            outerScroll.style.overflowX = "auto";
            outerScroll.style.whiteSpace = "nowrap";
            outerScroll.style.height = "auto";
            outerScroll.title = json.id;
                  
            var wrap = document.createElement('div');
            newdiv.append(outerScroll);

          

         } catch (e) {
            console.log(e);
         }



/**************** TODO: structured content rendering ****************
              
                   
                   var hostdiv = document.createElement('div');
                   hostdiv.setAttribute("class","hostagent");
                   var newdiv = document.createElement('div');
                   newdiv.setAttribute("class","agent");
                   newdiv.innerHTML = JSON.stringify(change.event.content);               
                   var maindiv = document.getElementById('log');
                   maindiv.appendChild(hostdiv);
                   hostdiv.appendChild(newdiv); */
              
         break;
              
              
              
              
        case 'ContentEvent':
              
              console.log(change);
            
             
               if(change.originatorId===me){
                   var space = document.createElement('div');
                   space.setAttribute("class","spacecustomer");
                   var options = {'weekday': 'long', 'month': '2-digit', 'day': '2-digit', 'hour': '2-digit', 'minute': '2-digit', 'second': '2-digit'};
                   space.innerHTML = new Date(change.serverTimestamp).toLocaleString('it-IT', options);
                   var maindiv = document.getElementById('log');
                   maindiv.appendChild(space);
                   
                   var hostdiv = document.createElement('div');
                   hostdiv.setAttribute("class","hostcustomer");
                   var newdiv = document.createElement('div');
                   newdiv.setAttribute("class","customer");
                   newdiv.innerHTML = change.event.message;                
                   var maindiv = document.getElementById('log');
                   maindiv.appendChild(hostdiv);
                   hostdiv.appendChild(newdiv);
               }
              
               else{
                   var space = document.createElement('div');
                   space.setAttribute("class","spaceagent");
                   var options = {'weekday': 'long', 'month': '2-digit', 'day': '2-digit', 'hour': '2-digit', 'minute': '2-digit', 'second': '2-digit'};
                   space.innerHTML = new Date(change.serverTimestamp).toLocaleString('it-IT', options);
                   var maindiv = document.getElementById('log');
                   maindiv.appendChild(space);
                   
                   var hostdiv = document.createElement('div');
                   hostdiv.setAttribute("class","hostagent");
                   var newdiv = document.createElement('div');
                   newdiv.setAttribute("class","agent");
                   newdiv.innerHTML = change.event.message;                
                   var maindiv = document.getElementById('log');
                   maindiv.appendChild(hostdiv);
                   hostdiv.appendChild(newdiv);
                  
               }
              
              break;
              
              
              var textarea = document.getElementById('log');
              textarea.scrollTop = textarea.scrollHeight;
      }
    }));
  // subscribe to open conversations metadata
  socket.subscribeExConversations({
    'convState': ['OPEN']
  }).then(resp => {
    var openConvs = {};
    socket.onNotification(withSubscriptionID(resp.body.subscriptionId),
      (notificationBody) => handleConversationNotification(socket,notificationBody,openConvs));
    $('#send').prop('disabled', false).click(() => {
        
       if($('#textline').val()) {
         if (Object.keys(openConvs)[0]) {
           publishTo(socket,Object.keys(openConvs)[0]);
         } else  {
           socket.consumerRequestConversation()
             .then(resp => publishTo(socket,resp.body.conversationId));
         }
       }
        
    });
    $('#close').prop('disabled', false).click(() => {
      if (Object.keys(openConvs)[0]) {
        socket.updateConversationField({
            conversationId: Object.keys(openConvs)[0],
            conversationField: [{
                    field: "ConversationStateField",
                    conversationState: "CLOSE"
                }]
        });
      }
    });
  });
  $('#connect').text('disconnect').unbind('click').click(() => socket.ws.close());
  socket.ws.onclose = (evt) => onCloseSocket(socket,evt);
}
    

    

    
    
function handleConversationNotification(socket,notificationBody,openConvs) {
  notificationBody.changes.forEach(change => {
    if (change.type === 'UPSERT') {
      if (!openConvs[change.result.convId]) {
        openConvs[change.result.convId] = change.result;
        socket.subscribeMessagingEvents({
          fromSeq: 0,
          dialogId: change.result.convId
        });
      }
    } else if (change.type === 'DELETE') {
      delete openConvs[change.result.convId];
      // $('#log').append(`La conversazione e' stata chiusa.\n`);
      var space = document.createElement('div');
      space.setAttribute("class","space");        
      var maindiv = document.getElementById('log');
      maindiv.appendChild(space);
        
      var newdiv = document.createElement('div');
      newdiv.setAttribute("class","chiusura");
      newdiv.innerHTML = "- La conversazione e' stata chiusa -";
      var mydiv = document.getElementById('log');
      mydiv.appendChild(newdiv);
    }
  });
}
function onCloseSocket(socket,evt) {
  socket.ws = null;
  // $('#log').append(`connection was closed with code ${evt.code}\n`);
  console.log("closed");
  prepareToConnect();
  $('#send').prop('disabled', true).unbind('click');
  $('#account').prop('disabled',false).val();
  $('#connect').click();        
}
function publishTo(socket,convID) {
  socket.publishEvent({
    dialogId: convID,
    event: {
      type: 'ContentEvent',
      contentType: 'text/plain',
      message: $('#textline').val()
    }
  })
  .then(resp => $('#textline').val(''));
}
function withSubscriptionID(subscriptionID) {
  return notif => notif.body.subscriptionId === subscriptionID;
}
function withType(type) {
  return notif => notif.type.includes(type);
}
function myId(jwt) {
  return JSON.parse(atob(jwt.split('.')[1])).sub;
}
const apiRequestTypes = ['cqm.SubscribeExConversations','ms.PublishEvent','cm.ConsumerRequestConversation','ms.SubscribeMessagingEvents','InitConnection','cm.UpdateConversationField'];
</script>
